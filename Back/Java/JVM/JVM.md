# JVM

- JVM(Java Virtual Machine)은 자바 바이트 코드를 실행하는 가상 머신이다.
- JVM은 자바 바이트 코드를 OS에 맞게 해석하여 실행한다.
- JVM은 메모리 관리, Garbage Collection을 수행한다.
- JVM은 스택 기반의 가상 머신이다.

## JVM 구조

### Class Loader
- .class 파일을 읽어들여 메모리에 적재하는 역할을 한다.
- 로딩, 링크, 초기화의 3단계로 클래스를 사용할 수 있게 한다.
    - **로딩:** 클래스 파일을 읽어들여 메모리에 적재
    - **링크:** 클래스 파일을 사용하기 위해 검증 하는 과정
      - 검증 : 자바 언어 명세에 명시된 대로 구성되어 있는지 확인
      - 준비 : 클래스 변수(static 변수)와 기본값에 메모리를 할당
      - 해결 : 심볼릭 메모리 레퍼런스를 메모리 주소로 변경
        - 초기화 이전까지는 실제 메모리 주소가 할당되지 않는다.
    - **초기화:** 클래스 변수(static 변수)를 초기화하거나 static 블록을 실행
- 로딩, 링크, 초기화는 클래스가 처음 사용될 때 한다.
```java
public class MyClass {
    static int count = 10; // 클래스 변수 선언 및 초기화

    public static void main(String[] args) {
        System.out.println(MyClass.count); // MyClass가 처음 사용되는 시점에 로딩, 링크, 초기화가 수행된다.
    }
}
```

### Execution Engine
- Class Loader에 의해 Runtime Data area(메모리)에 적재된 바이트 코드를 실행하는 역할을 한다.
- 자바 바이트 코드(*.class)는 기계가 바로 수행할 수 있는 언어보다는 가상머신이 이해할 수 있는 중간 레벨로 컴파일 된 코드
- 바이트 코드를 명령어 단위로 읽어서 실행한다.
- JIT(Just-In-Time) 컴파일러를 통해 바이트 코드를 네이티브 코드로 변환하여 실행한다.
    - JIT 컴파일러는 반복되는 코드를 찾아 네이티브 코드로 변환한다.
    - 네이티브 코드는 실행 속도가 빠르다.
    - 
#### JIT(Just-In-Time) 컴파일러
- JIT 컴파일러는 바이트코드를 기계어로 동적으로 변환하여 프로그램 실행 속도를 향상시킨다.
- 인터프리터 방식으로 실행 중 반복적으로 실행되는 바이트코드를 감지하여 네이티브 코드로 변환하고 캐싱한다.
- 이로 인해 자주 호출되는 메소드의 실행 속도가 크게 향상된다.

### Runtime Data Area

- JVM 메모리 영역으로 Java Application 을 실행할 때 사용되는 데이터들을 적재하는 영역
- JVM이 프로그램을 실행하기 위해 OS로부터 할당받은 메모리 공간이다.
- Runtime Data Area는 Method Area, Heap, Stack, PC Register, Native Method Stack으로 구성된다.
    - **Method Area:** 클래스 정보, 상수, static 변수 등이 저장된다.
        - JVM이 시작할 때 생성되는 영역으로 모든 스레드가 공유한다.
            - Field 정보 : 멤버 변수이름, 데이터 타입, 접근 제어자 정보
            - Method 정보 : 메서드 이름, 리턴 타입, 매개변수, 접근 제어자 정보
            - Type 정보 : 클래스, 인터페이스, Enum, Annotation
        - 클래스 정보, 상수, static 변수 등이 저장된다.
        - 프로그램이 종료 될 때까지 유지된다.
        - JDK 7까지는 PermGen 영역으로 불렸으나, JDK 8부터는 Metaspace로 변경되었다.
    - **Heap:** new 키워드로 생성된 객체, 배열이 저장된다.
        - Heap 영역은 JVM이 시작할 때 생성되는 영역으로 모든 스레드가 공유한다.
    - **Stack:** 메서드 호출 시 마다 생성되는 스레드, 지역 변수, 매개변수, 리턴 값 등이 저장된다.
        - Stack Frame : 메서드 호출 시마다 생성되는 스택 프레임으로 지역 변수, 매개변수, 리턴 값, 연산시 결과값 등이 저장된다.
            - 단, 데이터 타입에 따라서 저장되는 위치가 다르다.
                - 기본 데이터 타입 변수는 스택 영역
                - 참조타입 변수는 힙 영역의 객체 주소값을 저장하고, 스택 영역에는 객체 주소값이 저장된다.
            - 각 스레드마다 생성되며, 메서드 호출 시마다 생성되고 메서드 종료 시 소멸된다.
            - 프로세스가 메모리에 로드 될 때 스택 사이즈가 고정되며, 런타임 시 스택 사이즈를 바꿀 수는 없다.
    - **PC Register:** 스레드마다 생성되는 스레드, 스레드가 실행할 다음 명령어의 주소가 저장된다.
    - **Native Method Stack:** 자바 외의 언어로 작성된 네이티브 코드가 저장된다.

### Native Method Interface
- 자바 외의 언어로 작성된 네이티브 코드를 실행하는 역할을 한다.
- JNI(Java Native Interface)를 통해 자바 코드와 네이티브 코드를 연결한다.
- JNI는 자바 코드와 네이티브 코드 간의 데이터를 주고 받는 역할을 한다.




참조
- https://inpa.tistory.com/entry/JAVA-%E2%98%95-JVM-%EB%82%B4%EB%B6%80-%EA%B5%AC%EC%A1%B0-%EB%A9%94%EB%AA%A8%EB%A6%AC-%EC%98%81%EC%97%AD-%EC%8B%AC%ED%99%94%ED%8E%B8